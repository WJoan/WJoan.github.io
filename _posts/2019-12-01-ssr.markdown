---
layout:     post
title:      "React SSR ä»‹ç»"
subtitle:   "What & Why & How"
date:       2019-12-01 20:06:36
author:     "Joan"
tags:		["React", "Node"]
---

## What & Why

SSR çš„å…¨ç§°ä¸º **Server Side Rendering** å³æœåŠ¡ç«¯æ¸²æŸ“ï¼Œè¿™é‡Œçš„**æ¸²æŸ“**æŒ‡çš„å…¶å®å°±æ˜¯***ç”Ÿæˆ HTML é¡µé¢***ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç«¯æ¸²æŸ“å‘¢ï¼Ÿ

### æ¸²æŸ“

é¦–å…ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åŸæ¥æ˜¯å¦‚ä½•æ¸²æŸ“çš„ã€‚åœ¨ä¸€èˆ¬çš„ React é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬çš„ HTML é€šå¸¸æ˜¯è¿™ä¸ªæ ·å­ï¼š

```HTML
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>React App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>
```

å¯ä»¥çœ‹åˆ°è¿™æ®µ HTML æ–‡ä»¶ä¸­å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå†…å®¹ï¼Œå®ƒæ¸²æŸ“å‡ºæ¥çš„å°†ä¼šæ˜¯ä¸€ä¸ª**ç©ºç™½çš„é¡µé¢**ã€‚å¯¹äº SEO æ¥è¯´ï¼Œé™¤äº†`meta`æ ‡ç­¾ä¸­çš„å†…å®¹å¤–å°±æ²¡æœ‰å…¶ä»–ä¿¡æ¯äº†ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„é¡µé¢æ˜¯ä»€ä¹ˆæ—¶å€™è¢«æ¸²æŸ“å‡ºæ¥çš„å‘¢ï¼Ÿ

```jsx
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

ReactDOM.render(<App />, document.getElementById('root'));
```

å¦‚ä¸Šæ˜¾ç¤ºäº†ä¸€ä¸ª React ç¨‹åºçš„å…¥å£æ–‡ä»¶ï¼Œ**ReactDOM** ä¼šé€šè¿‡ **render** æ–¹æ³•å®Œæˆ HTML é¡µé¢çš„æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯è¯´**æˆ‘ä»¬çš„é¡µé¢æ˜¯é€šè¿‡ JavaScript ä»£ç åŠ¨æ€ç”Ÿæˆçš„ï¼Œè€Œä¸æ˜¯ä¸€å¼€å§‹å°±å­˜åœ¨äº HTML æ–‡ä»¶ä¸­çš„ã€‚**

### ç™½å±

åœ¨ JS æ–‡ä»¶åŠ è½½å¹¶è¿è¡Œå‰ï¼Œç”¨æˆ·åªèƒ½çœ‹åˆ°ä¸€ä¸ªç©ºç™½çš„é¡µé¢ï¼Œä¹Ÿå°±æ˜¯æœ€åˆåªåŒ…å« `<div id="root"></div>` ç»“ç‚¹çš„ HTML è§£æå‡ºçš„ DOM ç»“æ„ã€‚

<img src="{{site.baseurl}}/img/2019-12-01/1_CRiH0hUGoS3aoZaIY4H2yg.png">

ä¸ºäº†ä¼˜åŒ–è¿™ä¸ª**ç™½å±**æ—¶é—´ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ **SSR** åœ¨æœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªåŒ…å«å…·ä½“å†…å®¹çš„ HTML æ–‡ä»¶ï¼Œä½¿ç”¨æˆ·åœ¨ç¬¬ä¸€æ¬¡è®¿é—®çš„ HTML ä¹‹åèƒ½å¤Ÿé©¬ä¸Šå¾—åˆ°ä¸€ä¸ªå®Œæ•´å¯çœ‹çš„ç½‘é¡µã€‚

<img src="{{site.baseurl}}/img/2019-12-01/1_jJkEQpgZ8waQ5P-W5lhxuQ.png">

### SEO

ä½¿ç”¨ **SSR** çš„å¦å¤–ä¸€ä¸ªé‡è¦åŸå› å°±æ˜¯ä¸ºäº†**æœç´¢å¼•æ“ä¼˜åŒ–ï¼ˆSEOï¼‰**ï¼Œä¸‹é¢çš„è§†é¢‘ç®€å•ä»‹ç»äº†ä»€ä¹ˆæ˜¯ SEOï¼š

<iframe width="800" height="450" src="https://www.youtube.com/embed/hF515-0Tduk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
å¯¹äºå•†åŸç±»çš„åº”ç”¨ï¼Œ SEO å†…å®¹å°±æ˜¾å¾—æ¯”è¾ƒé‡è¦äº†ï¼Œå› æ­¤æˆ‘ä»¬æœ€åˆçš„ HTML æ–‡ä»¶ä¸­åº”è¯¥åŒ…å«ç½‘ç«™çš„ä¸€äº›å…³é”®å†…å®¹å’Œå…³é”®ä¿¡æ¯ã€‚



## Howï¼Ÿ

çŸ¥é“äº†ä»€ä¹ˆæ˜¯ SSR ä»¥åŠä¸ºä»€ä¹ˆéœ€è¦ SSR ä¹‹åï¼Œå°±è¦å¼€å§‹åœ¨æœåŠ¡ç«¯ç”Ÿæˆ HTML é¡µé¢äº†ã€‚

### Node.js

åœ¨æœåŠ¡ç«¯ç”Ÿæˆ HTML çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ JSPã€PHP Smarty ç­‰ç­‰ï¼Œä½†æ˜¯ä½œä¸ºå‰ç«¯äººå‘˜æˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›ä½¿ç”¨ Javascript è¿™ä¸ªç†Ÿæ‚‰çš„è¯­è¨€æ¥å®Œæˆè¿™é¡¹ä»»åŠ¡ã€‚è¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ° **Node.JS** äº†ã€‚

> **NodeJS** æ˜¯ä¸€ç§javascriptçš„è¿è¡Œç¯å¢ƒï¼Œèƒ½å¤Ÿä½¿å¾— Javascript è„±ç¦»æµè§ˆå™¨è¿è¡Œã€‚[è¯¦ç»†ä»‹ç»](https://medium.com/the-node-js-collection/why-the-hell-would-you-use-node-js-4b053b94ab8e)

åœ¨ Node.JS çš„ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Javascript åƒå…¶ä»–æœåŠ¡ç«¯è¯­è¨€ä¸€æ ·è®¿é—®å’Œæ›´æ”¹æœ¬åœ°æ–‡ä»¶ï¼Œå¯ä»¥å‘é€å’Œæ¥æ”¶ HTTP è¯·æ±‚ç­‰ç­‰ã€‚

å½“ç„¶ä½¿ç”¨ **Node.JS** ä¹Ÿä¸ä»…ä»…æ˜¯å› ä¸ºç†Ÿæ‚‰ï¼Œè¿˜å› ä¸ºå®ƒå¯ä»¥å®Œæˆå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„**åŒæ„**ã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ä¸€å¥— React ä»£ç å³å¯ä»¥åœ¨æœåŠ¡ç«¯ç”Ÿæˆé¡µé¢ï¼Œä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯è¿è¡Œå®Œæˆé¡µé¢äº¤äº’ã€‚

### ä¸€ä¸ªç®€å•çš„æœåŠ¡

ä¸‹é¢æˆ‘ä»¬æ ¹æ®è¿™ä¸ªç®€å•çš„æœåŠ¡æ¥è¿›è¡Œè¯´æ˜ï¼š

```javascript
import path from 'path';
import fs from 'fs';

import React from 'react';
import express from 'express';
import ReactDOMServer from 'react-dom/server';

import App from '../src/App';

const PORT = process.env.PORT || 3006;
const app = express();

app.use(express.static('./build'));

app.get('/*', (req, res) => {
  const reactApp = ReactDOMServer.renderToString(<App />);

  const indexFile = path.resolve('./build/index.html');
  fs.readFile(indexFile, 'utf8', (err, data) => {
    if (err) {
      console.error('Something went wrong:', err);
      return res.status(500).send('Oops, better luck next time!');
    }

    return res.send(
      data.replace('<div id="root"></div>', `<div id="root">${reactApp}</div>`)
    );
  });
});

app.listen(PORT, () => {
  console.log(`ğŸ˜ Server is listening on port ${PORT}`);
});
```

1. **ä½¿ç”¨ `express` æ­å»ºä¸€ä¸ªç®€å•çš„æœåŠ¡ï¼š**

   å¯åŠ¨è¿™ä¸ªæœåŠ¡åå®ƒä¼šç›‘å¬ 3006 ç«¯å£ï¼Œå½“æ¥æ”¶åˆ° `GET` è¯·æ±‚æ—¶å®ƒä¼šè¿”å›ç‰¹å®šçš„å†…å®¹ã€‚

   

2. **ç”Ÿæˆ HTML ç»“ç‚¹å­—ç¬¦ä¸²ï¼š**

   ```jsx
   const reactApp = ReactDOMServer.renderToString(<App />);
   ```

   **ReactDOMServer** å¯ä»¥å°† React å…ƒç´ æ¸²æŸ“ä¸ºåˆå§‹ HTML ç»“ç‚¹ï¼Œ`renderToString` æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª HTML å­—ç¬¦ä¸²ã€‚è¿™ä¸€é˜¶æ®µä¸­ï¼ŒReact ä¼šå¯¹ HTML ä¸­éœ€è¦ç»‘å®šäº‹ä»¶çš„ç»“ç‚¹è¿›è¡Œä¸€äº›æ ‡è®°ã€‚

   è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¯¹äºè¿™ç§åŒæ„çš„åº”ç”¨ï¼Œåœ¨å®¢æˆ·ç«¯æ¸²æŸ“æ—¶éœ€è¦ç”¨ ***hydrate*** ä»£æ›¿ ***render*** ï¼š

   ```jsx
   ReactDOM.hydrate(<App />, document.getElementById('root'));
   ```

   `hydrate`æ–¹æ³•ä¸ä¼šå®Œå…¨åœ¨é‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢äº†ï¼Œå¹¶ä¸”å®ƒä¼šä¸ºæœ‰ç‰¹æ®Šæ ‡è®°çš„ç»“ç‚¹ç»‘å®šç›‘å¬äº‹ä»¶ã€‚

   

3. **å°† HTML ç»“ç‚¹å­—ç¬¦ä¸²æ”¾å…¥ HTML æ¨¡ç‰ˆä¸­ï¼š**

   ```javascript
   data.replace('<div id="root"></div>', `<div id="root">${reactApp}</div>`)
   ```

   åœ¨ä¸Šä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç”Ÿæˆäº†é¡µé¢çš„ä¸»è¦å†…å®¹ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæˆçš„ HTMLï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›å†…å®¹å¡«å……åˆ°ä¸€ä¸ªå®Œæˆçš„ HTML æ¨¡ç‰ˆä¸­ã€‚æœ€åˆåªåŒ…å« `<div id="root"></div>` ç»“ç‚¹çš„ HTML æ–‡ä»¶å°±å¯ä»¥ä½œä¸ºæ¨¡ç‰ˆæ–‡ä»¶ã€‚

> [ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å®ä¾‹](https://alligator.io/react/server-side-rendering/)



## åŒæ„

åœ¨æœåŠ¡ç«¯åªéœ€è¦æ¸²æŸ“å‡ºé¡µé¢æœ€åˆçš„çŠ¶æ€å±•ç¤ºç»™ç”¨æˆ·ï¼Œè¿™æ—¶å€™é¡µé¢ä¸åº”è¯¥åŒ…æ‹¬æ¥å£æ•°æ®ã€ç”¨æˆ·çŠ¶æ€ï¼ˆå¦‚ç™»é™†ä¿¡æ¯ï¼‰ã€æµè§ˆå™¨ç›¸å…³ä¿¡æ¯ç­‰ã€‚åœ¨æ˜ç¡®äº†è¿™ä¸€ç‚¹ä¹‹åï¼Œåœ¨åŒæ„è¿‡ç¨‹ä¸­è¿˜éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

### è¿è¡Œç¯å¢ƒå·®å¼‚

ä½¿ç”¨ Web API çš„æ—¶å€™éœ€è¦æ ¼å¤–æ³¨æ„ï¼Œå› ä¸ºå®ƒä»¬åœ¨æœåŠ¡ç«¯æ— æ³•ä½¿ç”¨ã€‚

- HTML æ–‡æ¡£å¯¹è±¡ï¼ˆdocumentã€DOMï¼‰
- æµè§ˆå™¨å¯¹è±¡ï¼ˆwindowã€navigatorç­‰ï¼‰
- å­˜å‚¨å¯¹è±¡ï¼ˆlocalStorageã€sessionStorageç­‰ï¼‰

è¿™äº› Web API éœ€è¦é¿å…åœ¨å¦‚ä¸‹çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨ï¼š

- constructor
- [getDerivedStateFromProps](https://reactjs.org/docs/react-component.html#static-getderivedstatefromprops)
- [componentWillMount](https://reactjs.org/docs/react-component.html#unsafe_componentwillmount) (å·²åºŸå¼ƒ)

![React 16 lifecircle](/Users/wangjing/Documents/èµ„æ–™/MK image/0_OoDfQ7pzAqg6yETH.jpeg)



å¦‚æœä½ ä¸€å®šè¦åœ¨è¿™äº›ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨ä¸åŒç¯å¢ƒçš„ APIï¼Œéœ€è¦åšå¥½å…¼å®¹æ€§å¤„ç†ï¼Œä½†æ˜¯è¿™æ ·åšä¾ç„¶æœ‰å¾ˆä¸¥é‡çš„è´Ÿé¢ä½œç”¨ã€‚

```jsx
constructor(props) {
  super(props)
  this.state = {
    data: typeof window !== 'undefined' ? 'client' : 'server'
  }
}
render()
  return <div>{this.state.data}</div>
}
```
ä¸Šé¢çš„çœ‹ä¼¼æ²¡æœ‰é—®é¢˜ï¼Œä¹Ÿä¸ä¼šå¾—åˆ°æŠ¥é”™ã€‚ä½†æ˜¯å®ƒä¼šå¯¼è‡´å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¸²æŸ“å‡ºæ¥çš„å†…å®¹ä¸ä¸€è‡´ï¼Œåœ¨ `hydrate` æ˜¯ä¼šå‡ºç°é—®é¢˜ã€‚è¿™é‡Œåªæ˜¯æ–‡æœ¬ä¸ä¸€è‡´ï¼Œå¦‚æœæ˜¯ç»„ä»¶ä¸ä¸€è‡´é‚£ä¹ˆä¼šå¯¼è‡´ç»“ç‚¹æŒ‚è½½é”™è¯¯ã€æ ·å¼æ··ä¹±ï¼Œè¿™ä¸ªæ—¶å€™æ— è®ºæ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯éƒ½ä¸ä¼šæç¤ºé”™è¯¯ã€‚

```javascript
index.js:2178 Warning: Text content did not match. Server: "server" Client: "client"
```
æˆ‘ä»¬å¿…é¡»ç†è§£å¹¶ä¸”éµå¾ª React è®¾è®¡çš„åŸåˆ™ï¼Œä¸ºäº†è§£å†³ä¸¤ç§ç¯å¢ƒçš„å·®å¼‚ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å°†è¿™äº› API è½¬ç§»åˆ°æœåŠ¡ç«¯ä¸ä¼šåˆ°è¾¾çš„ç”Ÿå‘½å‘¨æœŸä¸­ã€‚

```jsx
constructor(props) {
  super(props)
  this.state = {
    ssrDone: false
  }
}
componentDidMount() {
  this.setState({ ssrDone: true, online: navigator.onLine })
}
render() {
  if(!this.state.ssrDone) {
    return (
      <div>loading...</div>
    )
  }
  return <div>{this.state.online ? 'on' : 'off'}</div>
}
```

> `useEffect` ä¼šåœ¨ `componentDidMount` å’Œ `componentDidUpdate` è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æ‰§è¡Œï¼Œå› æ­¤ `useEffect` ä¸­æ‰§è¡Œçš„å†…å®¹ä¸éœ€è¦å¯¹æœåŠ¡ç«¯åšç‰¹æ®Šå¤„ç†ã€‚

### è·¯ç”±

å¤§å¤šæ•° React åº”ç”¨éƒ½ä¼šæ¶‰åŠåˆ°è·¯ç”±é—®é¢˜ï¼Œå¯¹äºæœåŠ¡ç«¯æ¸²æŸ“ **React Router** æä¾›äº† `StaticRouter` æ¥ä»£æ›¿å®¢æˆ·ç«¯çš„ `BrowserRouter`ã€‚

```jsx
const html = ReactDOMServer.renderToString(
	<StaticRouter location={req.url} context={context}>
		<App />
	</StaticRouter>
);
```

å…¶ä¸­ **location** æ˜¯è¯·æ±‚çš„ URL åœ°å€çš„å­—ç¬¦ä¸²ï¼Œå®ƒè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡  `{ pathname, search, hash, state }`

**context** æ˜¯ç»„ä»¶ä¸æœåŠ¡ç«¯æ²Ÿé€šçš„æ¡¥æ¢ã€‚å­ç»„ä»¶å¯ä»¥é€šè¿‡ props çš„ **staticContext** å­—æ®µè·å–ã€æ›´æ”¹è¿™ä¸ªå€¼ã€‚

```jsx
// ç»„ä»¶
import React from 'react';

export default ({ staticContext = {} }) => {
  staticContext.status = 404;
  return <h1>Oops, nothing here!</h1>;
};
```

æ¯”å¦‚åº”ç”¨å†…æ²¡æœ‰åŒ¹é…å¯¹åº” URL çš„æ—¶å€™ä¼šæ¸²æŸ“ 404 ç»„ä»¶ï¼Œå¯ä»¥åœ¨ **staticContext** æ•°æ®ä¸­è¿›è¡Œæ ‡è®°ã€‚ç„¶åæœåŠ¡ç«¯å°±å¯ä»¥è·å–åˆ°è¿™ä¸ªä¿¡æ¯ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚

```javascript
// æœåŠ¡ç«¯
if (context.status === 404) {
  res.status(404);
}
```

å†æ¯”å¦‚åœ¨æœåŠ¡ç«¯éœ€è¦å…ˆåŠ è½½ä¸€äº›æ•°æ®ï¼Œå†æ¸²æŸ“ç»„ä»¶çš„æ—¶å€™ï¼Œç»„ä»¶å†…éƒ¨ä¹Ÿå¯ä»¥è·å–åˆ°æœåŠ¡ç«¯çš„æ•°æ®ï¼š

```jsx
// å¼‚æ­¥åŠ è½½çš„æ•°æ®
const context = { data };

const app = ReactDOMServer.renderToString(
	<StaticRouter location={req.url} context={context}>
		<App />
	</StaticRouter>
);
```

```jsx
// ç»„ä»¶æ„é€ å‡½æ•°
constructor(props) {
  super(props);

  // åœ¨å®¢æˆ·ç«¯ props ä¸­æ²¡æœ‰ staticContext !!!
  if (props.staticContext && props.staticContext.data) {
    this.state = {
      data: props.staticContext.data
    };
  } else {
    this.state = {
      data: []
    };
  }
}
```

[æ›´å¤šç”¨ä¾‹](https://alligator.io/react/react-router-ssr/)

### æ•°æ®

ä¸€äº›é…ç½®æ•°æ®éœ€è¦ä»æ¥å£ä¸­è·å–ï¼Œç„¶ååœ¨æ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚åœ¨æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬ä»æ¥å£ä¸­è·å–æ•°æ®åï¼Œå¯ä»¥é€šè¿‡ä¸Šé¢çš„ **staticContext** æˆ–è€…ç›´æ¥æ”¾åœ¨ **props** ä¸­ã€‚

å¯¹äºå®¢æˆ·ç«¯æ¥è¯´è¿™éƒ¨åˆ†æ•°æ®å·²ç»åœ¨æœåŠ¡ç«¯è·å–å¹¶æ¸²æŸ“å‡ºæ¥äº†ï¼Œæ²¡å¿…è¦å†è·å–ä¸€éã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡ç«¯å°†è¿™éƒ¨åˆ†æ•°æ®æ¸²æŸ“åˆ° HTML ä¸­ã€‚

```html
<script>window.__PRELOADED_STATE__ = {...}</script>
```

åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬ç›´æ¥ä» `window.__PRELOADED_STATE__` ä¸­è·å–æ•°æ®å°±å¯ä»¥äº†

```jsx
const data = window.__PRELOADED_STATE__ && window.__PRELOADED_STATE__.pagedata

ReactDOM.hydrate(
  <Root data={data} />,
  document.getElementById('root')
)
```



---

å‚è€ƒé“¾æ¥

[The Benefits of Server Side Rendering Over Client Side Rendering](https://medium.com/walmartlabs/the-benefits-of-server-side-rendering-over-client-side-rendering-5d07ff2cefe8)

[An Introduction to React Server-Side Rendering](https://alligator.io/react/server-side-rendering/)

[Using React Router 4 with Server-Side Rendering](https://alligator.io/react/react-router-ssr/)

[Why the Hell Would You Use Node.js](https://medium.com/the-node-js-collection/why-the-hell-would-you-use-node-js-4b053b94ab8e)

